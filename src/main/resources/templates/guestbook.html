<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>방명록</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

    <h1 th:text="${owner.loginId} + '님의 방명록'"></h1>
    <hr>

    <h3>남겨진 글들</h3>
    <div id="commentList">
        <p>로딩 중...</p>
    </div>
    <hr>

    <div sec:authorize="isAuthenticated()">
        <p>
            <strong>작성:</strong> 
            <input type="text" id="commentContent" placeholder="내용을 입력하세요" style="width: 300px;">
            <button onclick="writeComment()">등록</button>
        </p>
    </div>

    <div sec:authorize="isAnonymous()">
        <p>방명록을 남기려면 <a href="/login">로그인</a>이 필요합니다.</p>
    </div>
    
    <a href="/main">메인으로 가기</a>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // 방명록 주인 ID (DB의 PK)
        const guestbookId = /*[[${owner.userId}]]*/ '';
        const apiBase = '/api/comments/guestbook/' + guestbookId;

        // 페이지 열리면 목록 불러오기
        window.onload = function() {
            loadComments();
        };

        // 목록 불러오기 함수
        async function loadComments() {
            try {
                const res = await axios.get(apiBase);
                const comments = res.data;
                const listDiv = document.getElementById('commentList');

                if (comments.length === 0) {
                    listDiv.innerHTML = '<p>아직 작성된 글이 없습니다.</p>';
                    return;
                }

                // 목록 렌더링
                listDiv.innerHTML = comments.map(c => `
                    <div style="border-bottom: 1px solid #ccc; padding: 10px;">
                        <strong>${c.userId}</strong> 
                        <span style="font-size: small; color: gray;">
                            (${new Date(c.createdAt).toLocaleString()})
                        </span>
                        <br>
                        ${c.content}
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('commentList').innerHTML = '<p style="color:red">목록을 불러오지 못했습니다.</p>';
            }
        }

        // 댓글 등록 함수
        async function writeComment() {
            const input = document.getElementById('commentContent');
            const content = input.value.trim();

            if (!content) {
                alert('내용을 입력해주세요.');
                return;
            }

            try {
                await axios.post(apiBase, { content: content });
                alert('등록되었습니다!');
                input.value = ''; // 입력창 비우기
                loadComments();   // 목록 새로고침
            } catch (err) {
                alert('등록 실패: ' + (err.response ? err.response.data : err.message));
            }
        }
        /*]]>*/
    </script>
</body>
</html>